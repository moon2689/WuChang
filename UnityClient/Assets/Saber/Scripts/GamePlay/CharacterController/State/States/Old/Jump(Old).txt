using System;
using UnityEngine;

namespace Saber.CharacterController
{
    public class Jump : ActorStateBase
    {
        private const float k_SpeedSlow = 2, k_SpeedMedium = 5, k_SpeedFast = 10;

        private enum EState
        {
            JumpStart,
            JumpingInAir,
            JumpDodge,
            JumpLand,
        }

        private EState m_State;
        private float m_HorizontalSpeed;
        private Vector3 m_HorizontalSpeedV3;
        private float m_HighestPosY;
        private string m_LandAnim;
        private Vector3 m_LandSpeedDir;
        private float m_StartLandSpeed;
        private string m_StrDir;
        private bool m_DoubleJumped;
        private bool m_Dodged;
        private string m_DodgeAnim;
        private float m_ForceY;

        
        public override bool CanEnter => Actor.CPhysic.Grounded;
        public bool InAir { get; private set; }


        public Jump() : base(EStateType.Jump)
        {
        }

        public override void Enter()
        {
            base.Enter();

            m_State = EState.JumpStart;
            m_ForceY = Actor.PhysicInfo.m_JumpForceVertical;
            m_HighestPosY = float.MinValue;
            InAir = false;
            m_DoubleJumped = false;
            m_Dodged = false;

            Actor.CPhysic.EnableSlopeMovement = false;
            //GameApp.Entry.Game.Audio.Play3DSound("Sound/Actor/Jump", Actor.transform.position);

            //Debug.Log($"jump, {Parent.PreStateType}  {Actor.MoveSpeedV}");
            if (StateMachine.PreviousStateType == EStateType.Move)
            {
                m_HorizontalSpeed = Actor.MoveSpeedV switch
                {
                    EMoveSpeedV.None => 0,
                    EMoveSpeedV.Walk => k_SpeedSlow,
                    EMoveSpeedV.Run => k_SpeedMedium,
                    EMoveSpeedV.Sprint => k_SpeedFast,
                    _ => throw new InvalidOperationException("unknown speed:" + Actor.MoveSpeedV),
                };
                m_HorizontalSpeedV3 = Actor.DesiredMoveDir * m_HorizontalSpeed;
            }
            else
            {
                m_HorizontalSpeedV3 = Vector3.zero;
                //m_HorizontalSpeed = Vector3.ProjectOnPlane(Actor.CPhysic.RB.velocity, Vector3.up);
            }

            m_StrDir = Get4DirString();
            Actor.CAnim.Play($"Jump{m_StrDir}Start{AnimEndStringByArmed}");
        }

        string Get4DirString()
        {
            if (Actor.MovementAxisMagnitude < 0.1f)
            {
                return "Inplace";
            }

            // Vector3 fromV = Actor.transform.forward;
            // Vector3 toV = Actor.DesiredMoveDir;
            Vector3 fromV = new Vector3(0, 0, 1);
            Vector3 toV = Actor.MovementAxis;
            GameHelper.EDir4 dir = toV.Calc4Dir(fromV, out _);
            return dir.ToString();
        }

        public override void OnTriggerAnimEvent(AnimPointTimeEvent eventObj)
        {
            base.OnTriggerAnimEvent(eventObj);
            if (eventObj.EventType == EAnimTriggerEvent.JumpToAir)
            {
                InAir = true;
            }
        }

        public bool DoubleJump()
        {
            if (!m_DoubleJumped && m_State == EState.JumpingInAir)
            {
                m_StrDir = Get4DirString();
                Actor.CAnim.Play($"Jump{m_StrDir}Double{AnimEndStringByArmed}");
                Actor.CPhysic.ResetGravityValues();
                m_DoubleJumped = true;
                m_HighestPosY = 0;
                Actor.CPhysic.ApplyRootMotion = false;
                m_ForceY = Actor.PhysicInfo.m_JumpForceVertical;
                return true;
            }

            return false;
        }

        public bool Dodge()
        {
            if (!m_Dodged && m_State == EState.JumpingInAir)
            {
                GameHelper.EDir8 dir = GameHelper.EDir8.Front;
                if (Actor.MovementAxisMagnitude >= 0.1f)
                {
                    dir = Actor.MovementAxis.Calc8Dir(new Vector3(0, 0, 1), out _);
                }

                m_DodgeAnim = $"JumpDodge{dir}{AnimEndStringByArmed}";
                Actor.CAnim.Play(m_DodgeAnim);
                Actor.CPhysic.UseGravity = false;
                Actor.CPhysic.ApplyRootMotion = true;
                m_State = EState.JumpDodge;
                m_Dodged = true;
                m_ForceY = 0;
                m_HighestPosY = 0;
                m_StrDir = Get4DirString();

                if (m_HorizontalSpeed < k_SpeedSlow)
                    m_HorizontalSpeed = k_SpeedSlow;
                m_HorizontalSpeedV3 = Actor.DesiredMoveDir * m_HorizontalSpeed;
                return true;
            }

            return false;
        }

        public override void OnStay()
        {
            base.OnStay();

            if (m_State == EState.JumpStart)
            {
                Actor.CPhysic.AdditivePosition += m_HorizontalSpeedV3 * DeltaTime * 0.3f;
                if (InAir)
                {
                    float verticelForce = Mathf.Max(10, m_ForceY); //低于6可能跳不起来
                    Actor.CPhysic.AdditivePosition += verticelForce * Vector3.up * DeltaTime;
                    if (!Actor.CPhysic.Grounded)
                    {
                        m_State = EState.JumpingInAir;
                    }
                }
            }
            else if (m_State == EState.JumpingInAir)
            {
                Actor.CPhysic.AdditivePosition += m_HorizontalSpeedV3 * DeltaTime;
                if (m_ForceY > 0)
                    Actor.CPhysic.AdditivePosition += m_ForceY * Vector3.up * DeltaTime;

                // 控制
                if (Actor.MovementAxisMagnitude > 0.1f)
                {
                    Actor.CPhysic.ControlInAir();
                }

                if (m_HighestPosY < Actor.transform.position.y)
                {
                    m_HighestPosY = Actor.transform.position.y;
                }

                if (Actor.CPhysic.Grounded)
                {
                    float fallHeight = m_HighestPosY - Actor.transform.position.y;
                    if (fallHeight > 10)
                        m_LandAnim = $"JumpEndHeavy{AnimEndStringByArmed}";
                    else
                        m_LandAnim = $"Jump{m_StrDir}End{AnimEndStringByArmed}";

                    Actor.CAnim.Play(m_LandAnim);

                    m_State = EState.JumpLand;
                    InAir = false;

                    m_StartLandSpeed = m_HorizontalSpeedV3.magnitude * 0.5f;
                    m_LandSpeedDir = m_HorizontalSpeedV3.normalized;

                    //GameApp.Entry.Game.Audio.Play3DSound("Sound/Actor/JumpLand", Actor.transform.position);
                }
            }
            else if (m_State == EState.JumpDodge)
            {
                Actor.CPhysic.AdditivePosition += m_HorizontalSpeedV3 * DeltaTime;
                if (!base.Actor.CAnim.IsPlayingOrWillPlay(m_DodgeAnim))
                {
                    m_State = EState.JumpingInAir;
                    base.Actor.CPhysic.UseGravity = true;
                    Actor.CPhysic.ApplyRootMotion = false;
                }
            }
            else if (m_State == EState.JumpLand)
            {
                if (!Actor.CAnim.IsPlayingOrWillPlay(m_LandAnim))
                    Exit();

                if (m_StartLandSpeed > 0)
                {
                    Actor.CPhysic.AdditivePosition += m_LandSpeedDir * m_StartLandSpeed * DeltaTime;
                    m_StartLandSpeed -= DeltaTime * 3f;
                }
            }
        }

        protected override void OnExit()
        {
            base.OnExit();
            Actor.CPhysic.EnableSlopeMovement = true;
        }
    }
}